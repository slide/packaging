<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs" xmlns:fire="http://wixtoolset.org/schemas/v4/wxs/firewall" xmlns:util="http://wixtoolset.org/schemas/v4/wxs/util">
  <Package Name="$(var.ProductName) $(var.ProductVersion)" UpgradeCode="$(var.ProductCode)" Language="1033" Codepage="1252" Version="$(var.EncodedVersion)" Manufacturer="$(var.ProductVendor)" InstallerVersion="200">
    <SummaryInformation Keywords="Installer" Description="$(var.ProductName)" />
    <Media Id="1" Cabinet="$(var.ArtifactName).cab" EmbedCab="yes" />

    <Icon Id="installer.ico" SourceFile="$(var.InstallerIco)" />
    <Binary Id="JenkinsCA" SourceFile="..\JenkinsCA\bin\Release\net40\JenkinsCA.CA.dll"/>
    <Binary Id="SuccessIco" SourceFile="bitmaps\Success.ico" />
    <Binary Id="ErrorIco" SourceFile="bitmaps\Error.ico" />

    <CustomAction Id="Regex_Match" DllEntry="RegexMatch" BinaryRef="JenkinsCA" Execute="immediate" Return="check"/>
    <CustomAction Id="Check_Credentials" DllEntry="CheckCredentials" BinaryRef="JenkinsCA" Execute="immediate" Return="check"/>
    <CustomAction Id="Check_CredentialsWithPrivilege" DllEntry="CheckCredentials" BinaryRef="JenkinsCA" Execute="immediate" Return="check"/>
    <CustomAction Id="Check_Membership" DllEntry="CheckMembership" BinaryRef="JenkinsCA" Execute="immediate" Return="check"/>
    <CustomAction Id="Directory_Object_Picker" DllEntry="DirectoryObjectPicker" BinaryRef="JenkinsCA" Execute="immediate" Return="check" />
    <CustomAction Id="ValidateJavaHome" DllEntry="ValidateJavaHome" BinaryRef="JenkinsCA" Execute="immediate" Return="check" />

    <!-- Save the command line value INSTALLDIR and restore it later in the sequence or it will be overwritten by the value saved to the registry during an upgrade -->
    <!-- http://robmensching.com/blog/posts/2010/5/2/the-wix-toolsets-remember-property-pattern/ -->
    <CustomAction Id="SaveCmdLineValueINSTALLDIR" Property="CMDLINE_INSTALLDIR" Value="[INSTALLDIR]" Execute="firstSequence" />
    <CustomAction Id="SetFromCmdLineValueINSTALLDIR" Property="JENKINSDIR" Value="[CMDLINE_INSTALLDIR]" Execute="firstSequence" />
    <InstallUISequence>
        <Custom Action="SaveCmdLineValueINSTALLDIR" Before="AppSearch" />
        <Custom Action="SetFromCmdLineValueINSTALLDIR" After="AppSearch" Condition="CMDLINE_INSTALLDIR" />
    </InstallUISequence>
    <InstallExecuteSequence>
        <Custom Action="SaveCmdLineValueINSTALLDIR" Before="AppSearch" />
        <Custom Action="SetFromCmdLineValueINSTALLDIR" After="AppSearch" Condition="CMDLINE_INSTALLDIR" />
    </InstallExecuteSequence>

    <!-- Save the command line value PORT and restore it later in the sequence or it will be overwritten by the value saved to the registry during an upgrade -->
    <!-- http://robmensching.com/blog/posts/2010/5/2/the-wix-toolsets-remember-property-pattern/ -->
    <CustomAction Id="SaveCmdLineValuePORT" Property="CMDLINE_PORT" Value="[PORT]" Execute="firstSequence" />
    <CustomAction Id="SetFromCmdLineValuePORT" Property="PORTNUMBER" Value="[CMDLINE_PORT]" Execute="firstSequence" />
    <InstallUISequence>
        <Custom Action="SaveCmdLineValuePORT" Before="AppSearch" />
        <Custom Action="SetFromCmdLineValuePORT" After="AppSearch" Condition="CMDLINE_PORT" />
    </InstallUISequence>
    <InstallExecuteSequence>
        <Custom Action="SaveCmdLineValuePORT" Before="AppSearch" />
        <Custom Action="SetFromCmdLineValuePORT" After="AppSearch" Condition="CMDLINE_PORT" />
    </InstallExecuteSequence>

    <!-- Save the command line value JAVA_HOME and restore it later in the sequence or it will be overwritten by the value saved to the registry during an upgrade -->
    <!-- http://robmensching.com/blog/posts/2010/5/2/the-wix-toolsets-remember-property-pattern/ -->
    <CustomAction Id="SaveCmdLineValueJAVA_HOME" Property="CMDLINE_JAVA_HOME" Value="[JAVA_HOME]" Execute="firstSequence" />
    <CustomAction Id="SetFromCmdLineValueJAVA_HOME" Property="JAVA_HOME" Value="[CMDLINE_JAVA_HOME]" Execute="firstSequence" />
    <InstallUISequence>
        <Custom Action="SaveCmdLineValueJAVA_HOME" Before="AppSearch" />
        <Custom Action="SetFromCmdLineValueJAVA_HOME" After="AppSearch" Condition="CMDLINE_JAVA_HOME" />
    </InstallUISequence>
    <InstallExecuteSequence>
        <Custom Action="SaveCmdLineValueJAVA_HOME" Before="AppSearch" />
        <Custom Action="SetFromCmdLineValueJAVA_HOME" After="AppSearch" Condition="CMDLINE_JAVA_HOME" />
    </InstallExecuteSequence>

    <!-- Save the command line value SERVICE_USERNAME and restore it later in the sequence or it will be overwritten by the value saved to the registry during an upgrade -->
    <!-- http://robmensching.com/blog/posts/2010/5/2/the-wix-toolsets-remember-property-pattern/ -->
    <CustomAction Id="SaveCmdLineValueSERVICE_USERNAME" Property="CMDLINE_SERVICE_USERNAME" Value="[SERVICE_USERNAME]" Execute="firstSequence" />
    <CustomAction Id="SetFromCmdLineValueSERVICE_USERNAME" Property="SERVICE_USERNAME" Value="[CMDLINE_SERVICE_USERNAME]" Execute="firstSequence" />
    <InstallUISequence>
        <Custom Action="SaveCmdLineValueSERVICE_USERNAME" Before="AppSearch" />
        <Custom Action="SetFromCmdLineValueSERVICE_USERNAME" After="AppSearch" Condition="CMDLINE_SERVICE_USERNAME" />
    </InstallUISequence>
    <InstallExecuteSequence>
        <Custom Action="SaveCmdLineValueSERVICE_USERNAME" Before="AppSearch" />
        <Custom Action="SetFromCmdLineValueSERVICE_USERNAME" After="AppSearch" Condition="CMDLINE_SERVICE_USERNAME" />
    </InstallExecuteSequence>

    <!-- Save the command line value SERVICE_PASSWORD and restore it later in the sequence or it will be overwritten by the value saved to the registry during an upgrade -->
    <!-- http://robmensching.com/blog/posts/2010/5/2/the-wix-toolsets-remember-property-pattern/ -->
    <CustomAction Id="SaveCmdLineValueSERVICE_PASSWORD" Property="CMDLINE_SERVICE_PASSWORD" Value="[SERVICE_PASSWORD]" Execute="firstSequence" HideTarget="yes" />
    <CustomAction Id="SetFromCmdLineValueSERVICE_PASSWORD" Property="SERVICE_PASSWORD" Value="[CMDLINE_SERVICE_PASSWORD]" Execute="firstSequence" />
    <InstallUISequence>
        <Custom Action="SaveCmdLineValueSERVICE_PASSWORD" Before="AppSearch" />
        <Custom Action="SetFromCmdLineValueSERVICE_PASSWORD" After="AppSearch" Condition="CMDLINE_SERVICE_PASSWORD" />
    </InstallUISequence>
    <InstallExecuteSequence>
        <Custom Action="SaveCmdLineValueSERVICE_PASSWORD" Before="AppSearch" />
        <Custom Action="SetFromCmdLineValueSERVICE_PASSWORD" After="AppSearch" Condition="CMDLINE_SERVICE_PASSWORD" />
    </InstallExecuteSequence>

    <!-- Determine the directory of a previous installation (if one exists). If not JENKINSDIR stays empty -->
    <Property Id="JENKINSDIR">
        <RegistrySearch Id="DetermineInstallLocation" Type="raw" Root="HKLM" Key="Software\Jenkins\InstalledProducts\Jenkins" Name="InstallLocation" Bitness="always64" />
    </Property>

    <!-- Determine the port number of a previous installation -->
    <Property Id="PORTNUMBER">
        <RegistrySearch Id="DeterminePort" Type="raw" Root="HKLM" Key="Software\Jenkins\InstalledProducts\Jenkins" Name="Port" Bitness="always64" />
    </Property>
    <!-- Set default value if registry search comes up empty -->
    <SetProperty After="AppSearch" Id="PORTNUMBER" Value="8080" Condition="NOT PORTNUMBER" />

    <!-- Determine the JENKINS_ROOT of a previous installation -->
    <Property Id="JENKINS_ROOT">
      <RegistrySearch Id="DetermineJenkinsRoot" Type="raw" Root="HKLM" Key="Software\Jenkins\InstalledProducts\Jenkins" Name="JenkinsRoot" Bitness="always64" />
    </Property>
    <SetProperty After="AppSearch" Id="JENKINS_ROOT" Value="%LocalAppData%\Jenkins\" Condition="NOT JENKINS_ROOT" />

    <Property Id="SERVICE_USERNAME">
      <RegistrySearch Id="DetermineServiceUsername" Type="raw" Root="HKLM" Key="Software\Jenkins\InstalledProducts\Jenkins" Name="SU" Bitness="always64" />
    </Property>

    <Property Id="SERVICE_PASSWORD_ENC">
      <RegistrySearch Id="DetermineServicePassword" Type="raw" Root="HKLM" Key="Software\Jenkins\InstalledProducts\Jenkins" Name="SP" Bitness="always64" />
    </Property>

    <Property Id="CRYPTUNPROTECT_FLAGS" Value="CRYPTPROTECT_LOCAL_MACHINE|CRYPTPROTECT_UI_FORBIDDEN" />
    <CustomAction Id="SetEncryptedServicePASSWORD" Property="CRYPTUNPROTECT_DATA" Value="[SERVICE_PASSWORD_ENC]" />
    <CustomAction Id="DecryptServicePassword" DllEntry="CryptUnprotectDataHex" Execute="immediate" BinaryRef="JenkinsCA" />
    <CustomAction Id="SetServiceDecryptedPASSWORD" Property="SERVICE_PASSWORD" Value="[CRYPTUNPROTECT_RESULT]" />

    <Property Id="CRYPTPROTECT_FLAGS" Value="CRYPTPROTECT_LOCAL_MACHINE|CRYPTPROTECT_UI_FORBIDDEN" />
    <CustomAction Id="EncryptServicePassword" DllEntry="CryptProtectDataHex" Execute="immediate" BinaryRef="JenkinsCA" />
    <CustomAction Id="SetServiceEncryptedPASSWORD" Property="SERVICE_PASSWORD_ENC" Value="[CRYPTPROTECT_RESULT]" />

    <!-- These lock down the permissions for the Jenkins directory (where it's installed) so that normal users can't mess with the files -->

    <!--
        S-1-5-19     LocalService
        S-1-5-32-544 Local Administrators group
        S-1-5-18     Local System
    -->
    <SetProperty Id="SetDirectoryPermissionsLocalSystem" Before="SetDirectoryPermissionsLocalSystem" Sequence="execute" Value="&quot;[System64Folder]icacls.exe&quot; &quot;[JENKINSDIR_STRIPPED]&quot; /inheritance:r /grant *S-1-5-19:(OI)(CI)(F) /grant *S-1-5-32-544:(OI)(CI)(F) /grant *S-1-5-18:(OI)(CI)(F)" />

    <CustomAction Id="SetDirectoryPermissionsLocalSystem" DllEntry="WixQuietExec64" Execute="deferred" Return="check" Impersonate="no" BinaryRef="Wix4UtilCA_$(sys.BUILDARCHSHORT)" />

    <SetProperty Id="SetDirectoryPermissionsServiceAccount" Before="SetDirectoryPermissionsServiceAccount" Sequence="execute" Value="&quot;[System64Folder]icacls.exe&quot; &quot;[JENKINSDIR_STRIPPED]&quot; /inheritance:r /grant *S-1-5-32-544:(OI)(CI)(F) /grant &quot;[SERVICE_USERNAME]&quot;:(OI)(CI)(F)" />

    <CustomAction Id="SetDirectoryPermissionsServiceAccount" DllEntry="WixQuietExec64" Execute="deferred" Return="check" Impersonate="no" BinaryRef="Wix4UtilCA_$(sys.BUILDARCHSHORT)" />

    <!-- This will find the JRE/JDK directory either Java 17 or 21 (prefer 17) -->
    <Property Id="JAVA_HOME">
      <RegistrySearch Id="JDK21_HOME_REGSEARCH" Root="HKLM" Key="SOFTWARE\JavaSoft\JDK\21" Name="JavaHome" Type="raw" Bitness="always64" />
      <RegistrySearch Id="JDK17_HOME_REGSEARCH" Root="HKLM" Key="SOFTWARE\JavaSoft\JDK\17" Name="JavaHome" Type="raw" Bitness="always64" />
    </Property>

    <Property Id="ARPPRODUCTICON" Value="installer.ico" />
    <Property Id="ARPNOREPAIR" Value="yes" Secure="yes" />      <!-- Remove repair -->
    <Property Id="ARPNOMODIFY" Value="yes" Secure="yes" />      <!-- Remove modify -->

    <Property Id="INSTALLLEVEL" Value="1" />

    <Upgrade Id="$(var.ProductCode)">
      <UpgradeVersion Minimum="0.0.0" Maximum="$(var.EncodedVersion)" Property="PREVIOUSVERSIONINSTALLED" />
    </Upgrade>

    <CustomAction Id="BackupJenkinsXmlFile" DllEntry="BackupJenkinsXmlFile" BinaryRef="JenkinsCA"/>

    <CustomAction Id="StripJenkinsDir" DllEntry="StripJenkinsDir" BinaryRef="JenkinsCA" />

    <InstallExecuteSequence>
      <!--
        Earlier I suffered a problem where after an upgrade, all the JRE files are removed
        (if I then repair the installation, it'll work, so it's not the missing definitions in the msi file.)

        I'm still new to MSI/WiX to be able to really understand what's going on, but
        http://www.mail-archive.com/wix-users@lists.sourceforge.net/msg32537.html seems to explain the problem,
        (as caused by the interaction between deferred removal), and the take away from this thread
        as a whole seems to be that for auto-generated wxs files (from heat), it's just not possible
        to get the file updates done right (WTF?!).

        The InstallInitialize seems to work. My naive hypothesis is that this stops the service and
        deletes all the files before new ones are added (OTOH, I still get a dialog that some files
        are in use and I need to reboot, so I could be all wrong, or maybe the installer is showing
        this dialog incorrectly as a precaution, as alluded in http://www.mail-archive.com/wix-users@lists.sourceforge.net/msg06878.html)

        I remember seeing another e-mail on the wix-users list about <ServiceControl> not actually
        waiting until the full termination of the service, and if so, this still might not work.

        In any case, noting my experiments so that future changes to this value will be done very carefully.
      -->
      <Custom Action="BackupJenkinsXmlFile" After="InstallInitialize" />
      <RemoveExistingProducts After="BackupJenkinsXmlFile" />

      <Custom Action="SetEncryptedServicePASSWORD" Before="InstallInitialize" Condition="SERVICE_PASSWORD_ENC" />
      <Custom Action="DecryptServicePassword" After="SetEncryptedServicePASSWORD" Condition="SERVICE_PASSWORD_ENC" />
      <Custom Action="SetServiceDecryptedPASSWORD" After="DecryptServicePassword" Condition="SERVICE_PASSWORD_ENC" />

      <Custom Action="EncryptServicePassword" Before="InstallFiles" Condition="SERVICE_PASSWORD" />
      <Custom Action="SetServiceEncryptedPASSWORD" After="EncryptServicePassword" Condition="SERVICE_PASSWORD" />

      <Custom Action="StripJenkinsDir" After="InstallFiles" Condition="NOT REMOVE" />
      <Custom Action="SetDirectoryPermissionsLocalSystem" After="StripJenkinsDir" Condition="SERVICE_LOGON_TYPE=&quot;ServiceLocalSystem&quot; AND NOT REMOVE" />
      <Custom Action="SetDirectoryPermissionsServiceAccount" After="StripJenkinsDir" Condition="SERVICE_LOGON_TYPE&lt;&gt;&quot;ServiceLocalSystem&quot; AND NOT REMOVE" />
    </InstallExecuteSequence>

    <Feature Id="Complete" Level="1" Title="Jenkins" TypicalDefault="install" InstallDefault="local" Display="expand" Description="The required Jenkins components" AllowAbsent="no">
      <ComponentRef Id="Main" />
      <ComponentRef Id="SettingsRegistryEntries" />
      <Feature Id="StartService" Level="1" Title="Start Service" Description="!(loc.StartJenkinsService_Description)">
        <ComponentRef Id="StartService" />
      </Feature>
      <Feature Id="FirewallException" Level="10" Title="Firewall Exception" Description="!(loc.FirewallException_Description)">
        <ComponentRef Id="FirewallException" />
      </Feature>
      <Feature Id="UninstallService" Display="hidden" Level="1" Title="Uninstall Service" Description="Uninstall the service on Jenkins uninstall" AllowAbsent="no">
        <ComponentRef Id="UninstallService" />
      </Feature>
    </Feature>

    <WixVariable Id="WixUILicenseRtf" Value="License.rtf" />
    <WixVariable Id="WixUIDialogBmp" Value="$(var.DialogBmp)" />
    <WixVariable Id="WixUIBannerBmp" Value="$(var.BannerBmp)" />

    <UI>
      <UIRef Id="WixUI_Common" />

      <Property Id="DefaultUIFont" Value="WixUI_Font_Normal" />
      <Property Id="WixUI_Mode" Value="FeatureTree" />

      <DialogRef Id="JavaHomeDlg" />
      <DialogRef Id="JavaBrowseDlg" />
      <DialogRef Id="BrowseDlg" />
      <DialogRef Id="DiskCostDlg" />
      <DialogRef Id="ErrorDlg" />
      <DialogRef Id="FatalError" />
      <DialogRef Id="CustomizeDlg" />
      <DialogRef Id="FilesInUse" />
      <DialogRef Id="MsiRMFilesInUse" />
      <DialogRef Id="PrepareDlg" />
      <DialogRef Id="ProgressDlg" />
      <DialogRef Id="ResumeDlg" />
      <DialogRef Id="UserExit" />
      <DialogRef Id="ServiceCredDlg" />
      <DialogRef Id="ServicePortDlg" />

      <Publish Dialog="BrowseDlg" Control="OK" Event="DoAction" Value="WixUIValidatePath_$(sys.BUILDARCHSHORT)" Order="3" />
      <Publish Dialog="BrowseDlg" Control="OK" Event="SpawnDialog" Value="InvalidDirDlg" Order="4" Condition="WIXUI_INSTALLDIR_VALID&lt;&gt;&quot;1&quot;" />

      <Publish Dialog="ExitDialog" Control="Finish" Event="EndDialog" Value="Return" Order="999" />

      <Publish Dialog="WelcomeDlg" Control="Next" Event="NewDialog" Value="InstallDirDlg" Condition="NOT Installed" />

      <Publish Dialog="InstallDirDlg" Control="Back" Event="NewDialog" Value="WelcomeDlg" />
      <Publish Dialog="InstallDirDlg" Control="Next" Event="SetTargetPath" Value="[WIXUI_INSTALLDIR]" Order="1" />
      <Publish Dialog="InstallDirDlg" Control="Next" Event="DoAction" Value="WixUIValidatePath_$(sys.BUILDARCHSHORT)" Order="2" Condition="NOT WIXUI_DONTVALIDATEPATH" />
      <Publish Dialog="InstallDirDlg" Control="Next" Event="SpawnDialog" Value="InvalidDirDlg" Order="3" Condition="NOT WIXUI_DONTVALIDATEPATH AND WIXUI_INSTALLDIR_VALID&lt;&gt;&quot;1&quot;" />
      <Publish Dialog="InstallDirDlg" Control="Next" Property="SERVICE_LOGON_TYPE" Value="ServiceAccount" Order="4" />
      <Publish Dialog="InstallDirDlg" Control="Next" Property="SERVICE_LOGON_TYPE" Value="ServiceLocalSystem" Order="5" Condition="SERVICE_USERNAME=&quot;LocalSystem&quot;" />
      <Publish Dialog="InstallDirDlg" Control="Next" Event="NewDialog" Value="ServiceCredDlg" Order="6" Condition="WIXUI_DONTVALIDATEPATH OR WIXUI_INSTALLDIR_VALID=&quot;1&quot;" />
      <Publish Dialog="InstallDirDlg" Control="ChangeFolder" Property="_BrowseProperty" Value="[WIXUI_INSTALLDIR]" Order="1" />
      <Publish Dialog="InstallDirDlg" Control="ChangeFolder" Event="SpawnDialog" Value="BrowseDlg" Order="2" />


      <Publish Dialog="ServiceCredDlg" Control="Next" Property="JENKINS_ROOT" Value="%ProgramData%\Jenkins\" Order="1" Condition="SERVICE_LOGON_TYPE=&quot;ServiceLocalSystem&quot;" />
      <Publish Dialog="ServiceCredDlg" Control="Next" Event="NewDialog" Value="ServicePortDlg" Order="2" Condition="NOT Installed" />
      <Publish Dialog="ServiceCredDlg" Control="Back" Event="NewDialog" Value="InstallDirDlg" Order="1" Condition="NOT Installed" />

      <Publish Dialog="ServicePortDlg" Control="Next" Event="NewDialog" Value="JavaHomeDlg" Order="1" Condition="NOT Installed" />
      <Publish Dialog="ServicePortDlg" Control="Back" Event="NewDialog" Value="ServiceCredDlg" Order="1" Condition="NOT Installed" />

      <Publish Dialog="JavaHomeDlg" Control="Next" Event="NewDialog" Value="CustomizeDlg" Order="1" Condition="NOT Installed" />
      <Publish Dialog="JavaHomeDlg" Control="Back" Event="NewDialog" Value="ServicePortDlg" Order="1" Condition="NOT Installed" />

      <Publish Dialog="CustomizeDlg" Control="Back" Event="NewDialog" Value="JavaHomeDlg" Order="2" Condition="NOT Installed" />
      <Publish Dialog="CustomizeDlg" Control="Next" Event="NewDialog" Value="VerifyReadyDlg" />

      <Publish Dialog="VerifyReadyDlg" Control="Back" Event="NewDialog" Value="CustomizeDlg" Order="1" Condition="NOT Installed" />
      <Publish Dialog="VerifyReadyDlg" Control="Back" Event="NewDialog" Value="MaintenanceTypeDlg" Order="2" Condition="Installed" />

      <Publish Dialog="MaintenanceWelcomeDlg" Control="Next" Event="NewDialog" Value="MaintenanceTypeDlg" />

      <Publish Dialog="MaintenanceTypeDlg" Control="RepairButton" Event="NewDialog" Value="VerifyReadyDlg" />
      <Publish Dialog="MaintenanceTypeDlg" Control="RemoveButton" Event="NewDialog" Value="VerifyReadyDlg" />
      <Publish Dialog="MaintenanceTypeDlg" Control="Back" Event="NewDialog" Value="MaintenanceWelcomeDlg" />

      <Publish Dialog="ExitDialog" Control="Finish" Property="WixShellExecTarget" Value="http://localhost:[PORTNUMBER]/" Order="1" Condition="NOT Installed AND NOT REMOVE" />
      <Publish Dialog="ExitDialog" Control="Finish" Event="DoAction" Value="LaunchApplication" Order="2" Condition="ADDLOCAL &gt;&lt; &quot;StartService&quot; AND NOT Installed AND NOT REMOVE" />
    </UI>

    <!-- launch a browser at the end of the installation -->
    <CustomAction Id="LaunchApplication" DllEntry="WixShellExec" Impersonate="yes" BinaryRef="Wix4UtilCA_$(sys.BUILDARCHSHORT)" />

    <!-- Set JAVA_HOME to the JAVA_HOME environment variable if it is currently empty -->
    <SetProperty Id="JAVA_HOME" Action="SetJAVA_HOME_Default" Before="SetJAVA_HOME_Empty" Value="[%JAVA_HOME]" Condition="NOT JAVA_HOME" />
    <!-- Set JAVA_HOME to the Program Files directory if it is empty so the JavaHomeDlg doesn't have an issue -->
    <SetProperty Id="JAVA_HOME" Action="SetJAVA_HOME_Empty" Before="CostFinalize" Value="[ProgramFiles6432Folder]" Condition="NOT JAVA_HOME" />

    <Property Id="WIXUI_INSTALLDIR" Value="JENKINSDIR" />
      <StandardDirectory Id="ProgramFiles6432Folder">
        <Directory Id="JENKINSDIR" Name="$(var.ArtifactName)" FileSource=".">
          <Component Id="Main" Guid="e4a652bf-c210-4a45-95c4-5dc875b4880b" Bitness="always64">
            <File Name="jenkins.exe" Source="$(SolutionDir)/tmp/jenkins.exe" KeyPath="yes" Id="JenkinsExe" />
            <File Id="JenkinsXml" Name="jenkins.xml" Source="$(SolutionDir)/tmp/jenkins.xml" DiskId="1" />
            <File Id="jenkins.exe.config" Name="jenkins.exe.config" Source="jenkins.exe.config" DiskId="1" />
            <File Id="___var.ArtifactName_.war" Name="$(var.ArtifactName).war" Source="$(var.WAR)" DiskId="1" />

            <!-- Update the XML file with the values selected during install -->
            <util:XmlFile Id="JenkinsXmlJenkinsData" Action="setValue" ElementPath="//service/env/@value" File="[#JenkinsXml]" Value="[JENKINS_ROOT].jenkins" Sequence="1" />
            <util:XmlFile Id="JenkinsXmlExecutable" Action="setValue" ElementPath="//service/executable" File="[#JenkinsXml]" Value="[JAVA_HOME]\bin\java.exe" Sequence="1" />
            <util:XmlFile Id="JenkinsXmlArguments" Action="setValue" ElementPath="//service/arguments" File="[#JenkinsXml]" Value="-Xrs -Xmx256m -Dhudson.lifecycle=hudson.lifecycle.WindowsServiceLifecycle -jar &quot;[JENKINSDIR]jenkins.war&quot; --httpPort=[PORTNUMBER] --webroot=&quot;[JENKINS_ROOT]war&quot;" Sequence="1" />
            <util:XmlFile Id="JenkinsXmlExtensionsPidfile" Action="setValue" ElementPath="//service/extensions/extension/pidfile" File="[#JenkinsXml]" Value="[JENKINS_ROOT]jenkins.pid" Sequence="1" />
            <ServiceInstall Id="$(var.ArtifactName)Service" Name="$(var.ArtifactName)" DisplayName="$(var.ProductName)" Type="ownProcess" Start="auto" ErrorControl="normal" Description="$(var.ProductSummary)" Account="[SERVICE_USERNAME]" Password="[SERVICE_PASSWORD]" />
          </Component>

          <!-- Registry entries -->
          <Component Id="SettingsRegistryEntries" Guid="">
              <!-- Do NOT use the application's default registry key here, because THIS key will be removed on uninstall
                  (important when installing a newer version, because that is uninstall followed by install) -->
              <RegistryKey Root="HKLM" Key="Software\Jenkins\InstalledProducts\Jenkins">
                <RegistryValue Name="InstallLocation" Value="[JENKINSDIR]" Type="string" KeyPath="yes" />
                <RegistryValue Name="Port" Value="[PORTNUMBER]" Type="string" />
                <RegistryValue Name="SU" Value="[SERVICE_USERNAME]" Type="string" />
                <RegistryValue Name="SP" Value="[SERVICE_PASSWORD_ENC]" Type="string" />
                <RegistryValue Name="JenkinsRoot" Value="[JENKINS_ROOT]" Type="string" />
                <RegistryValue Name="JavaHome" Value="[JAVA_HOME]" Type="string" />
              </RegistryKey>
          </Component>

          <Component Id="StartService" Guid="6F6925C0-4D1F-4A1E-A4A9-BC83EB88637A">
            <CreateFolder />
            <ServiceControl Id="Control$(var.ArtifactName)Service" Name="$(var.ArtifactName)" Start="install" Stop="both" Wait="yes" Remove="uninstall" />
          </Component>

          <!--
            We have this for the case if someone doesn't have the service started during install, if that component isn't installed, then the service will
            not be uninstalled during uninstallation. This component makes sure that the service will be uninstalled correctly in this case.
          -->
          <Component Id="UninstallService" Guid="9D0DEE31-5560-4FDD-8A73-236A4102BFE0">
            <CreateFolder />
            <ServiceControl Id="Control$(var.ArtifactName)ServiceUninstall" Name="$(var.ArtifactName)" Stop="both" Wait="yes" Remove="uninstall" />
          </Component>

          <Component Id="FirewallException" Guid="">
            <CreateFolder />
            <fire:FirewallException Id="FwEx" Program="[JAVA_HOME]\bin\java.exe" Port="[PORTNUMBER]" Name="$(var.ArtifactName)" Scope="any" IgnoreFailure="yes" />
          </Component>
        </Directory>
      </StandardDirectory>
    </Package>
</Wix>
